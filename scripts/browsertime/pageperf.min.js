function inIframe(){try{return window.self!==window.top}catch(e){return!0}}function cumulativeLayoutShift(){let e=PerformanceObserver.supportedEntryTypes;if(!e||-1===e.indexOf("layout-shift"))return;let t=0,n=0,r=Number.NEGATIVE_INFINITY,o=Number.NEGATIVE_INFINITY,i=new PerformanceObserver((e=>{}));i.observe({type:"layout-shift",buffered:!0});let a=i.takeRecords();for(let e of a)e.hadRecentInput||((e.startTime-r>5e3||e.startTime-o>1e3)&&(r=e.startTime,n=0),o=e.startTime,n+=e.value,t=Math.max(t,n));return t}function observeAndReportFirstInputDelay(){const e=PerformanceObserver.supportedEntryTypes;e&&-1!==e.indexOf("first-input")&&new PerformanceObserver((e=>{for(entry of e.getEntries()){var t=Number((entry.processingStart-entry.startTime).toFixed(1)),n={};performance.getEntriesByType("paint").forEach((function(e){n[e.name]=e.startTime}));n["first-contentful-paint"];page_timings={_firstInputDelay:t},console.log("---\x3e"+page_timings),sendTimings(page_timings)}})).observe({type:"first-input",buffered:!0})}function largestContentfulPaint(){function e(e){let t=[];for(;null!=e.parentNode;){let n=0,r=0;for(let t=0;t<e.parentNode.childNodes.length;t++){let o=e.parentNode.childNodes[t];o.nodeName==e.nodeName&&(o===e&&(r=n),n++)}e.hasAttribute&&e.hasAttribute("id")&&""!=e.id?t.unshift(e.nodeName.toLowerCase()+"#"+e.id):n>1?t.unshift(e.nodeName.toLowerCase()+":eq("+r+")"):t.unshift(e.nodeName.toLowerCase()),e=e.parentNode}return t.slice(1)}let t={startTime:-1,size:-1,domPath:"",tag:""},n=PerformanceObserver.supportedEntryTypes;if(!n||-1===n.indexOf("largest-contentful-paint"))return t;let r=new PerformanceObserver((e=>{}));r.observe({type:"largest-contentful-paint",buffered:!0});let o=r.takeRecords(),i=[];for(let t of o){let n=t.element;i.push({duration:t.duration,id:t.id,url:t.url,loadTime:Number(t.loadTime.toFixed(0)),renderTime:Number(Math.max(t.renderTime,t.loadTime).toFixed(0)),size:t.size,startTime:Number(t.startTime.toFixed(0)),tagName:n?n.tagName:"",className:n?n.className:"",domPath:n?e(n).join(" > "):"",tag:n?n.cloneNode(!1).outerHTML:""})}let a=i.pop()||{};return t.startTime=a.startTime||t.startTime,t.size=a.size||t.size,t.domPath=a.domPath||t.domPath,t.tag=a.tag||t.tag,t}function navTimings(){let e=window.performance.getEntriesByType("navigation")[0];return e?{domainLookupTime:Number((e.domainLookupEnd-e.domainLookupStart).toFixed(0)),ttfb:Math.round(e.responseStart-e.requestStart),redirectionTime:Number((e.redirectEnd-e.redirectStart).toFixed(0)),serverConnectionTime:Number((e.connectEnd-e.connectStart).toFixed(0)),serverResponseTime:Number((e.responseEnd-e.requestStart).toFixed(0)),pageDownloadTime:Number((e.responseEnd-e.responseStart).toFixed(0)),domInteractiveTime:Number(e.domInteractive.toFixed(0)),domContentLoadedTime:Number(e.domContentLoadedEventStart.toFixed(0)),pageLoadTime:Number(e.loadEventStart.toFixed(0)),frontEndTime:Number((e.loadEventStart-e.responseEnd).toFixed(0)),backEndTime:Number(e.responseStart.toFixed(0))}:(e=window.performance.timing,{domainLookupTime:e.domainLookupEnd-e.domainLookupStart,redirectionTime:e.fetchStart-e.navigationStart,serverConnectionTime:e.connectEnd-e.connectStart,serverResponseTime:e.responseEnd-e.requestStart,pageDownloadTime:e.responseEnd-e.responseStart,domInteractiveTime:e.domInteractive-e.navigationStart,domContentLoadedTime:e.domContentLoadedEventStart-e.navigationStart,pageLoadTime:e.loadEventStart-e.navigationStart,frontEndTime:e.loadEventStart-e.responseEnd,backEndTime:e.responseStart-e.navigationStart,ttfb:e.responseStart-e.requestStart})}function firstPaint(){let e=window.performance,t=e.timing,n=e.getEntriesByType("paint");if(n.length>0)for(let e of n)if("first-paint"===e.name)return Number(e.startTime.toFixed(0));return t.timeToNonBlankPaint?Number((t.timeToNonBlankPaint-t.navigationStart).toFixed(0)):-1}function perfTimings(){if(inIframe())return;var e={};performance.getEntriesByType("paint").forEach((function(t){e[t.name]=t.startTime}));var t=performance.getEntriesByType("navigation")[0];n=navTimings();let r=n.domContentLoadedTime,o=n.pageLoadTime,i=n.ttfb,a=Math.round(e["first-contentful-paint"]),d=n.domInteractiveTime,s=firstPaint(),m=largestContentfulPaint(),u=cumulativeLayoutShift(),f=Math.round(t.domainLookupEnd-t.domainLookupStart),l=Math.round(t.requestStart-t.secureConnectionStart);return{title:window.document.title,onContentLoad:r,onLoad:o,_href:window.location.href,_dns:f,_ssl:l,_timeToFirstByte:i,_cumulativeLayoutShift:u,_largestContentfulPaint:m,_firstPaint:s,_domInteractive:d,_firstContentfulPaint:a}}function proxyMgmtURL(){return window.bupURL}function sendTimings(e){let t=new FormData;Object.keys(e).forEach((t=>void 0===e[t]?delete e[t]:{})),console.log(e),t.append("pageTiming",JSON.stringify(e)),"sendBeacon"in navigator&&(console.log("Send timings"),navigator.sendBeacon(proxyMgmtURL()+"/har/page_timings",t)||console.error("BrowserUpProxy sendbeacon page_timings error"))}function postPerf(){sendTimings(perfTimings())}function handleClose(){if(window.closeIsHandled)return!0;let e=document.title;console.log("Page change: "+e),window.closeIsHandled=!0,"sendBeacon"in navigator&&navigator.sendBeacon(proxyMgmtURL()+"/har/page?title="+e,{})}observeAndReportFirstInputDelay(),window.addEventListener("load",postPerf),window.addEventListener("beforeunload",handleClose),document.addEventListener("visibilitychange",(function(){"hidden"===document.visibilityState&&handleClose()}));
