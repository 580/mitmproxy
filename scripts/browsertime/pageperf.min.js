function inIframe(){try{return window.self!==window.top}catch(e){return!0}}function cumulativeLayoutShift(){let e=PerformanceObserver.supportedEntryTypes;if(!e||-1===e.indexOf("layout-shift"))return;let t=0,i=0,o=Number.NEGATIVE_INFINITY,r=Number.NEGATIVE_INFINITY,a=new PerformanceObserver(e=>{});a.observe({type:"layout-shift",buffered:!0});let d=a.takeRecords();for(let s of d)!s.hadRecentInput&&((s.startTime-o>5e3||s.startTime-r>1e3)&&(o=s.startTime,i=0),r=s.startTime,i+=s.value,t=Math.max(t,i));return t}function observeAndReportFirstInputDelay(){let e=PerformanceObserver.supportedEntryTypes;e&&-1!==e.indexOf("first-input")&&new PerformanceObserver(e=>{for(entry of e.getEntries()){let t=Number((entry.processingStart-entry.startTime).toFixed(1));window.bupFirstInputDelay=t}}).observe({type:"first-input",buffered:!0})}function largestContentfulPaint(){function e(e){let t=[];for(;null!=e.parentNode;){let i=0,o=0;for(let r=0;r<e.parentNode.childNodes.length;r++){let a=e.parentNode.childNodes[r];a.nodeName==e.nodeName&&(a===e&&(o=i),i++)}e.hasAttribute&&e.hasAttribute("id")&&""!=e.id?t.unshift(e.nodeName.toLowerCase()+"#"+e.id):i>1?t.unshift(e.nodeName.toLowerCase()+":eq("+o+")"):t.unshift(e.nodeName.toLowerCase()),e=e.parentNode}return t.slice(1)}let t={startTime:-1,size:-1,domPath:"",tag:""},i=PerformanceObserver.supportedEntryTypes;if(!i||-1===i.indexOf("largest-contentful-paint"))return t;let o=new PerformanceObserver(e=>{});o.observe({type:"largest-contentful-paint",buffered:!0});let r=o.takeRecords(),a=[];for(let d of r){let s=d.element;a.push({duration:d.duration,id:d.id,url:d.url,loadTime:Number(d.loadTime.toFixed(0)),renderTime:Number(Math.max(d.renderTime,d.loadTime).toFixed(0)),size:d.size,startTime:Number(d.startTime.toFixed(0)),tagName:s?s.tagName:"",className:s?s.className:"",domPath:s?e(s).join(" > "):"",tag:s?s.cloneNode(!1).outerHTML:""})}let m=a.pop()||{};return t.startTime=m.startTime||t.startTime,t.size=m.size||t.size,t.domPath=m.domPath||t.domPath,t.tag=m.tag||t.tag,t}function navTimings(){let e=window.performance.getEntriesByType("navigation")[0];return e?{domainLookupTime:Number((e.domainLookupEnd-e.domainLookupStart).toFixed(0)),ttfb:Math.round(e.responseStart-e.requestStart),redirectionTime:Number((e.redirectEnd-e.redirectStart).toFixed(0)),serverConnectionTime:Number((e.connectEnd-e.connectStart).toFixed(0)),serverResponseTime:Number((e.responseEnd-e.requestStart).toFixed(0)),pageDownloadTime:Number((e.responseEnd-e.responseStart).toFixed(0)),domInteractiveTime:Number(e.domInteractive.toFixed(0)),domContentLoadedTime:Number(e.domContentLoadedEventStart.toFixed(0)),pageLoadTime:Number(e.loadEventStart.toFixed(0)),frontEndTime:Number((e.loadEventStart-e.responseEnd).toFixed(0)),backEndTime:Number(e.responseStart.toFixed(0))}:{domainLookupTime:(e=window.performance.timing).domainLookupEnd-e.domainLookupStart,redirectionTime:e.fetchStart-e.navigationStart,serverConnectionTime:e.connectEnd-e.connectStart,serverResponseTime:e.responseEnd-e.requestStart,pageDownloadTime:e.responseEnd-e.responseStart,domInteractiveTime:e.domInteractive-e.navigationStart,domContentLoadedTime:e.domContentLoadedEventStart-e.navigationStart,pageLoadTime:e.loadEventStart-e.navigationStart,frontEndTime:e.loadEventStart-e.responseEnd,backEndTime:e.responseStart-e.navigationStart,ttfb:e.responseStart-e.requestStart}}function firstPaint(){let e=window.performance,t=e.timing,i=e.getEntriesByType("paint");if(i.length>0){for(let o of i)if("first-paint"===o.name)return Number(o.startTime.toFixed(0))}return t.timeToNonBlankPaint?Number((t.timeToNonBlankPaint-t.navigationStart).toFixed(0)):-1}function perfTimings(){if(inIframe())return;var e={};performance.getEntriesByType("paint").forEach(function(t){e[t.name]=t.startTime});var t=performance.getEntriesByType("navigation")[0];let i=(n=navTimings()).domContentLoadedTime||-1,o=n.pageLoadTime||-1,r=n.ttfb||-1,a=Math.round(e["first-contentful-paint"])||-1,d=n.domInteractiveTime||-1,s=firstPaint()||-1,m=largestContentfulPaint()||-1,u=cumulativeLayoutShift()||-1,l=Math.round(t.domainLookupEnd-t.domainLookupStart)||-1,p=Math.round(t.requestStart-t.secureConnectionStart)||-1,f=window.bupFirstInputDelay||-1;return{title:window.document.title,onContentLoad:i,onLoad:o,_href:window.location.href,_dns:l,_ssl:p,_firstInputDelay:f,_timeToFirstByte:r,_cumulativeLayoutShift:u,_largestContentfulPaint:m,_firstPaint:s,_domInteractive:d,_firstContentfulPaint:a}}function proxyMgmtURL(){return window.bupURL}function sendTimings(e){let t=new FormData;Object.keys(e).forEach(t=>void 0===e[t]?delete e[t]:{}),console.log(e),t.append("pageTiming",JSON.stringify(e)),"sendBeacon"in navigator&&(console.log("Send timings"),navigator.sendBeacon(proxyMgmtURL()+"/har/page_timings",t)||console.error("BrowserUpProxy sendbeacon page_timings error"))}function postPageInfo(){sendTimings(perfTimings())}function handleClose(){if(window.closeIsHandled)return!0;window.closeIsHandled=!0,sendTimings(perfTimings())}observeAndReportFirstInputDelay(),window.addEventListener("load",postPageInfo),window.addEventListener("beforeunload",handleClose),document.addEventListener("visibilitychange",function(){"hidden"===document.visibilityState&&handleClose()});
